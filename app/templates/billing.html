{% extends "base.html" %}
{% block title %}Billing | Database for MVP{% endblock %}
{% block content %}

{% set invoices = current_user.invoices %}
{% set subscriptions = current_user.subscriptions %}


 <style>
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    .qr-code {
      text-align: center;
      margin: 1rem 0;
    }
    .crypto-address {
      word-break: break-all;
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    .cost-display {
      font-weight: bold;
      color: #28a745;
    }
    .error-text {
      color: #dc3545;
      display: none;
    }
  </style>


<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Billing & Invoices</h4>
</div>


<!-- subscriptions -->
{% if subscriptions %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Subscription ID</th>
          <th scope="col">Start Date</th>
          <th scope="col">End Date</th>
          <th scope="col">Status</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for sub in subscriptions %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ sub.id }}</td>
          <td>{{ sub.start_date.strftime("%Y-%m-%d") }}</td>
          <td>{{ sub.end_date.strftime("%Y-%m-%d") }}</td>
          <td>
            {% if sub.status == "active" %}
              <span class="badge bg-success">Active</span>
            {% elif sub.status != "active" %}
              <span class="badge bg-danger">Suspended</span>
            {% else %}
              <span class="badge bg-secondary">{{ sub.status|capitalize }}</span>
            {% endif %}
          </td>
          <td>
           
              <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#extendSubModal{{ sub.id }}">
                Extend
              </button>
            
          </td>
        </tr>

        
        
       <!-- Extend Modal -->
<div class="modal fade" id="extendSubModal{{ sub.id }}" onclick="initDatabaseExtension('{{ sub.id }}', {{ sub.plan.price }}, '{{ current_user.usdt_payment_address }}')" tabindex="-1" aria-labelledby="extendSubModalLabel{{ sub.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="extendSubModalLabel{{ sub.id }}">Extend Subscription</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('dashboard.submit_proof') }}" enctype="multipart/form-data" id="extendForm{{ sub.id }}">
        <div class="modal-body">
          <p>Extend your subscription for database <strong>{{ sub.sub_for }}</strong>.</p>

          <!-- Extension Period Selection -->
          <div class="mb-3">
            <label for="months{{ sub.id }}" class="form-label">Select months to extend</label>
            <select class="form-select" id="months{{ sub.id }}" name="months" required>
              <option value="" disabled selected>Select duration</option>
              <option value="1">1 month</option>
              <option value="2">2 months</option>
              <option value="3">3 months</option>
              <option value="6">6 months</option>
              <option value="12">12 months</option>
            </select>
          </div>

          <!-- Cost Display -->
          <div class="mb-3">
            <label class="form-label">Total Cost</label>
            <p class="cost-display" id="costDisplay{{ sub.id }}">$0.00</p>
          </div>

          <!-- Crypto Payment Details -->
          <div class="mb-3" id="cryptoDetails{{ sub.id }}" style="display: none;">
            <label class="form-label">Pay with Bitcoin</label>
            <p>Please send the exact amount to the following USDT (Tron TRC20) address:</p>
            <p class="crypto-address" id="cryptoAddress{{ sub.id }}">{{ CRYPTO_ADDRESS }}</p>
            <div class="qr-code" id="qrCode{{ sub.id }}"></div>
          </div>

          <!-- Payment Proof Upload -->
          <div class="mb-3">
            <label for="proof{{ sub.id }}" class="form-label">Upload Payment Proof</label>
            <input type="hidden" name="subscription-id" value="{{ sub.id }}">
            <input type="file" class="form-control" id="proof{{ sub.id }}" name="proof" accept="image/*,.pdf" required>
            <small class="form-text text-muted">Upload a screenshot or PDF of the transaction confirmation.</small>
          </div>

          <div class="mb-3">
            <label for="tx_hash"> Transaction Hash / ID (This will enable us verify your payment faster) </label>
            <input type="text" class="form-control" id="tx_hash" name="tx_hash" placeholder="Enter transaction hash or ID">
            <small class="form-text text-muted">Optional but recommended.</small>

          </div>

          <!-- Error Message -->
          <p class="error-text" id="errorText{{ sub.id }}">Please select a valid extension period and upload a valid file.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn{{ sub.id }}" disabled>Pay with USDT</button> or
          <button type="button" onclick="extend_subscription('{{ sub.id }}')" 
              class="btn btn-warning">Pay Securely</button>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- end of modal -->

        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-center p-5 bg-white border rounded-3">
    <p class="lead mb-2">No Subscriptions yet</p>
  </div>
{% endif %}










<!-- Invoices -->
{% if invoices %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Invoice ID</th>
          <th scope="col">Date</th>
          <th scope="col">Amount</th>
          <th scope="col">Status</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ inv.id }}</td>
          <td>{{ inv.period_start.strftime("%Y-%m-%d") + '-' + inv.period_end.strftime("%Y-%m-%d") }}</td>
          <td>${{ "%.2f"|format(inv.amount) }}</td>
          <td>
            {% if inv.status == "paid" %}
              <span class="badge bg-success">Paid</span>
            {% elif inv.status != "paid" %}
              <span class="badge bg-danger">Unpaid</span>
            {% else %}
              <span class="badge bg-secondary">{{ inv.status|capitalize }}</span>
            {% endif %}
          </td>
          <td>
            {% if inv.status != "paid" %}
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#payModal{{ inv.id }}">
                Pay with USDT
              </button>
              <a href="{{ url_for('payment.pay_invoice', invoice_id=inv.id) }}" 
                  class="btn btn-warning">Pay Securely </a>
              
            
            {% endif %}
          </td>
        </tr>

        <!-- Pay Now Modal -->
        <div class="modal fade" id="payModal{{ inv.id }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Pay Invoice {{ inv.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <form method="post" action="{{ url_for('dashboard.submit_proof') }}" enctype="multipart/form-data" >
                <div class="modal-body">
                  <p>Please follow the instructions below to complete your payment.</p>
                  <div class="alert alert-info small">
                    Send <strong>${{ "%.2f"|format(inv.amount) }}</strong> to our wallet/account.
                    <br>
                    Reference: <code>{{ inv.id }}</code>
                  </div>
                  <input type="number" name="invoice-id" value="{{inv.id}}" hidden>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="yes" id="advancePay{{ inv.id }}" name="advance">
                    <label class="form-check-label" for="advancePay{{ inv.id }}">
                      Pay in advance for future months
                    </label>
                  </div>
                  <div class="mt-3">
                    <label class="form-label">Upload proof of payment (screenshot / tx hash)</label>
                    <input type="file" class="form-control" name="payment_proof" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                  <button class="btn btn-primary" type="submit">Submit Payment</button>
                </div>
              </form>
            </div>
          </div>
        </div>

    


       


        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-center p-5 bg-white border rounded-3">
    <p class="lead mb-2">No invoices yet</p>
  </div>
{% endif %}








 <!-- Include qrcode.js for QR code generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
 
<script>
function initDatabaseExtension(subId, planPrice, cryptoAddress) {
  // Configuration variables
  const DATABASE_COST = planPrice; // Cost per month in USD
  const CRYPTO_ADDRESS = cryptoAddress;

  // Get DOM elements
  const form = document.getElementById(`extendForm${subId}`);
  const monthsSelect = document.getElementById(`months${subId}`);
  const costDisplay = document.getElementById(`costDisplay${subId}`);
  const cryptoDetails = document.getElementById(`cryptoDetails${subId}`);
  const cryptoAddressEl = document.getElementById(`cryptoAddress${subId}`);
  const qrCodeDiv = document.getElementById(`qrCode${subId}`);
  const proofInput = document.getElementById(`proof${subId}`);
  const submitBtn = document.getElementById(`submitBtn${subId}`);
  const errorText = document.getElementById(`errorText${subId}`);

  if (!form) return; // safety check

  // Update cost and show crypto details on month selection
  monthsSelect.addEventListener('change', () => {
    const months = parseInt(monthsSelect.value);
    if (isNaN(months)) {
      costDisplay.textContent = `$${DATABASE_COST}`;
      cryptoDetails.style.display = 'none';
      submitBtn.disabled = true;
      return;
    }

    const totalCost = (DATABASE_COST * months).toFixed(2);
    costDisplay.textContent = `$${totalCost}`;
    cryptoDetails.style.display = 'block';
    cryptoAddressEl.textContent = CRYPTO_ADDRESS;

    qrCodeDiv.innerHTML = '';

    // Generate QR code using qrcode.min.js (davidshimjs)
  qrCodeDiv.innerHTML = ''; // Clear previous QR code
  new QRCode(qrCodeDiv, {
    text: CRYPTO_ADDRESS,
    width: 150,
    height: 150,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });


    validateForm();
  });

  // Validate file input
  proofInput.addEventListener('change', validateForm);

  // Validation logic
  function validateForm() {
    const months = monthsSelect.value;
    const file = proofInput.files[0];
    const validFileTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];

    if (months && file && validFileTypes.includes(file.type)) {
      errorText.style.display = 'none';
      submitBtn.disabled = false;
    } else {
      errorText.style.display = 'block';
      submitBtn.disabled = true;
    }
  }

  // Prevent invalid form submission
  form.addEventListener('submit', (e) => {
    const months = monthsSelect.value;
    const file = proofInput.files[0];
    const validFileTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];

    if (!months || !file || !validFileTypes.includes(file.type)) {
      e.preventDefault();
      errorText.style.display = 'block';
    }
  });
}
</script>



{% endblock %}
